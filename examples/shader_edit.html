<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Import Shader Example</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
				position: absolute;
			}
			#container {
				position: absolute;
				display: inline;
			}

			#code {
				position: absolute;
				display: inline;
			}
		</style>
		

<!-- Shader imported inline: -->
<script type="x-shader/x-fragment" id="fs">

	// http://glslsandbox.com/e#22317.0

	vec2 pattern(vec2 p) {
		
		float a = atan(p.x,p.y);
		float r = 9.0 * pow(1.0/length(p), 0.4);
		float t = time + length(p) * 0.0012;
		return vec2(sin(a*3.0+cos(t*0.25)*10.0), sin(r*2.+sin(time*0.1)*10.0));
	}

	void main( void ) {

		vec2 p = (gl_FragCoord.xy/resolution.xy-.5) * 99.0;
		vec3 col = vec3(0.0);
		
		for (int i=0; i<3; i++)
			p.xy = pattern(p);
		
		col.xy = p.xy;
		col.z = max(step(abs(p.x*p.x),0.5), -1.0 / abs(p.y));
		
		gl_FragColor = vec4( col, 1.0 );

	}

</script>


		<!-- Import standard three.js stuff -->
		<script src="libs/Detector.js"></script>
		<script src="libs/three.min.js"></script>
		<script src="libs/TrackballControls.js"></script>


		<!-- Import library -->
		<!-- <script src="../build/pixelmixer.min.js"></script> -->
		<script src="../src/Pixelmixer.js"></script>
		<script src="../src/managers/AppManager.js"></script>
		<script src="../src/managers/PortManager.js"></script>
		<script src="../src/managers/HardwareManager.js"></script>
		<script src="../src/managers/ChannelManager.js"></script>
		<script src="../src/objects/Port.js"></script>
		<script src="../src/objects/Channel.js"></script>
		<script src="../src/objects/Pod.js"></script>
		<script src="../src/objects/Clip.js"></script>
		<script src="../src/objects/PodPosition.js"></script>
		<script src="../src/shaders/MainShader.js"></script>
		<script src="../src/shaders/PointCloudShader.js"></script>
		<script src="../src/shaders/ShaderUtils.js"></script>
		<script src="../src/shaders/SimpleTextureShader.js"></script>

		<script src="libs/codemirror.js"></script>
		<link rel="stylesheet" href="libs/codemirror.css">

		<script>

			if ( !Detector.webgl ) { Detector.addGetWebGLMessage(); } else {

				var glWidth = window.innerWidth;
				var glHeight = window.innerHeight;

				var scene;
				var renderer;
				var camera;
				var controls;
				var container;

				function onLoad(){


					var code = CodeMirror(document.body, {

						value: document.getElementById( 'fs' ).textContent,
						lineNumbers: true,
						matchBrackets: true,
						indentWithTabs: true,
						tabSize: 8,
						indentUnit: 8,
						mode: "text/x-glsl"
							
					});

					code.on("change", function() {
						PX.importShader("ImportSpiral", code.getValue());
						PX.updateShader = true;
					});


					// ** Standard Three.js setup

					scene = new THREE.Scene();

					renderer = new THREE.WebGLRenderer(); 
					renderer.setSize( glWidth, glHeight );
					renderer.autoClear = false;

					container = document.getElementById( 'container' );
					container.appendChild( renderer.domElement ); 

					camera = new THREE.PerspectiveCamera( 30, glWidth / glHeight, 1, 100000 );
					camera.position.z = 2000;
					controls = new THREE.TrackballControls( camera, renderer.domElement);



					// ** Initialize API

					PX.init(scene, renderer);
					PX.setSize(glWidth, glHeight);
					PX.pointSprite = "images/nodeflare250.png";



					// ** Add a simple grid of Nodes 

					var x = -470;		// Position coordinates for the entire grid
					var y = 120;
					var z = -0;
					var width = 52;		// How many pixels for the entire grid
					var height = 20;
					var pitch = 33;		// How far each pixel is spaced

					PX.hardware.addSimpleNodeGrid(x, y, z, width, height, pitch);
					PX.updateNodePoints();



					// ** Import shader from inline and add to Channel 1

					var fragmentShader = document.getElementById( 'fs' ).textContent;
					PX.importShader("ImportSpiral", fragmentShader);

					PX.simpleSetup({channel: 1, ids: ["ImportSpiral"]});



					// ** Start the main loop

					animate();


				}

				function animate() {

					// Main update loop
					if(PX.ready){

						// Update the API
						PX.update();

						// Update Three.js
						controls.update();
						renderer.render( scene, camera );
					}

					// Keep repeating the animation loop
					requestAnimationFrame( animate );
				}


				function onWindowResize() {

					// Resize logic
					glWidth = window.innerWidth;
					glHeight = window.innerHeight;

					PX.setSize(glWidth, glHeight);

					camera.aspect = glWidth / glHeight;
					camera.updateProjectionMatrix();
					controls.handleResize();

				}
				window.addEventListener( 'resize', onWindowResize, false );

			}

		</script>

	</head>

	<body ontouchstart="" onload="onLoad()">

		<div id="code"></div>
		<div id="container"></div>

	</body>

</html>