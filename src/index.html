<!DOCTYPE html>
<html lang="en">
	<head>
		<title>AP3.0 Editor Test</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<script src="js/libs/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>
		<script src="js/libs/signals.min.js"></script>

		<script src="js/libs/three/three.min.js"></script>
		<script src="js/libs/three/controls/TrackballControls.js"></script>

		<script src="js/audiopixel.js"></script>
		<script src="js/managers/AppManager.js"></script>
		<script src="js/managers/PortManager.js"></script>
		<script src="js/managers/HardwareManager.js"></script>
		<script src="js/managers/ChannelManager.js"></script>
		<script src="js/objects/Port.js"></script>
		<script src="js/objects/Channel.js"></script>
		<script src="js/objects/Pod.js"></script>
		<script src="js/objects/Clip.js"></script>
		<script src="js/shaders/core/ShaderUtils.js"></script>
		<script src="js/shaders/core/SimpleTextureShader.js"></script>
		<script src="js/shaders/core/NodeShader.js"></script>
		<script src="js/shaders/clips/BasicClip.js"></script>
	</head>

	<body ontouchstart="" onload="onLoad()">

		<link href="css/main.css" rel="stylesheet" />
		<link id="theme" href="css/light.css" rel="stylesheet" />

		<div id="container"></div>

		<script>

		if ( ! Detector.webgl ) { Detector.addGetWebGLMessage(); }

		var frameCount = 0;


		function onLoad(){

			// Register all clips by their id's for easy lookup later
			for (var property in ap.clips) {
				if (ap.clips.hasOwnProperty(property)) {
					ap.register[ap.clips[property].id] = property;
				}
			}



			// ****** Managers ******

			ap.app = new AppManager(document.getElementById( 'container' ));
			ap.ports = new PortManager();
			ap.hardware = new HardwareManager();
			ap.channels = new ChannelManager();

			ap.app.init();
			ap.ports.init();
			ap.hardware.init();
			ap.channels.init();



			// ****** Runtime Loop ****** 

			function animate() {

				//if(frameCount % 30 == 1){ // Slow framerate testing
				
				// ** Update 
				ap.app.update();
				ap.ports.update();
				ap.hardware.update();
				ap.channels.update();


				// Render next frame // TODO: throttle logic if needed
				requestAnimationFrame( animate );

				frameCount++;
			}

			animate();



			// ****** Event Handlers ****** 

			document.addEventListener( 'click', function ( event ) {

			}, false );

			document.addEventListener( 'dragover', function ( event ) {

			}, false );

			document.addEventListener( 'drop', function ( event ) {

			}, false );

			document.addEventListener( 'keydown', function ( event ) {

				switch ( event.keyCode ) {

					case 8: // prevent browser back
						event.preventDefault();
						break;
					case 46: // delete
						break;

				}

			}, false );

			var onWindowResize = function ( event ) {

			};

			window.addEventListener( 'resize', onWindowResize, false );

			setTimeout(onWindowResize, 10);

		}

		</script>

		<script id="fragment_shader_pass_1" type="x-shader/x-fragment">

			//#INCLUDESHADERUTILS

			precision mediump float;
			float ap_index;
			vec4  ap_xyz;
			//vec3  ap_lastRgb;
			vec3  ap_rgb;

			varying vec2 v_vUv;
			uniform float u_time;
			//uniform float u_random;
			uniform float u_mapSize;
			uniform sampler2D u_coordsMap;
			uniform sampler2D u_prevCMap;
			//uniform sampler2D u_portsMap;


			void main() {

				//********************************************
				ap_xyz = texture2D( u_coordsMap, v_vUv);
				if(ap_xyz[3] == 0.0){ discard; }

				ap_index = ((1.0 - v_vUv.y) * u_mapSize * u_mapSize + v_vUv.x * u_mapSize);
				//ap_lastRgb = vec3(texture2D( u_prevCMap, v_vUv));

				//********************************************

				//-----------------------------------------
				vec2 p = (((0.5 * 110000.) + 10000.) * vec2( ap_xyz[0] +  (ap_xyz[2] * 0.25), ap_xyz[1]) ) + 6.;

				float x = p.x;
				float y = p.y;
				float mov0 = x+y+cos(sin(u_time)*2.0)*100.+sin(x/100.)*1000.;
				float mov1 = y;
				float mov2 = x;
				float c1 = abs(sin(mov1+u_time)/2.+mov2/2.-mov1-mov2+u_time);
				float c2 = abs(sin(c1+sin(mov0/1000.+u_time)+sin(y/40.+u_time)+sin((x+y)/100.)*3.));
				float c3 = abs(sin(c2+cos(mov1+mov2+c2)+cos(mov2)+sin(x/1000.)));

				c1 = c1 * 0.25;
				ap_rgb = vec3(c2,c3,c1);

				gl_FragColor = vec4(ap_rgb, 1.0);

				//#INCLUDESHADERS

			}

		</script>
	</body>
</html>
