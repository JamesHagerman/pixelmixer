<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Fountain Example</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link href="css/main.css" rel="stylesheet" />
		

		<!-- Import standard three.js stuff -->
		<script src="libs/Detector.js"></script>
		<script src="libs/three.min.js"></script>
		<script src="libs/TrackballControls.js"></script>
		<script src="libs/dat.gui.min.js"></script>


		<!-- Import library -->
		<!-- <script src="../build/pixelmixer.min.js"></script> -->
		<script src="../src/Pixelmixer.js"></script>
		<script src="../src/managers/AppManager.js"></script>
		<script src="../src/managers/PortManager.js"></script>
		<script src="../src/managers/HardwareManager.js"></script>
		<script src="../src/managers/ChannelManager.js"></script>
		<script src="../src/objects/Port.js"></script>
		<script src="../src/objects/Channel.js"></script>
		<script src="../src/objects/Pod.js"></script>
		<script src="../src/objects/Clip.js"></script>
		<script src="../src/objects/PodPosition.js"></script>
		<script src="../src/shaders/MainShader.js"></script>
		<script src="../src/shaders/PointCloudShader.js"></script>
		<script src="../src/shaders/ShaderUtils.js"></script>
		<script src="../src/shaders/SimpleTextureShader.js"></script>


		<!-- Import Shaders -->
		<script src="import/shaders/SolidColor.js"></script>
		<script src="import/shaders/TestFrame.js"></script>
		<script src="import/shaders/DiSinSwirl.js"></script>
		<script src="import/shaders/ColorSineBar.js"></script>
		<script src="import/shaders/ColorSwirls.js"></script>
		<script src="import/shaders/LineCosSin.js"></script>
		<script src="import/shaders/SimpleSwirl.js"></script>
		<script src="import/shaders/SinSpiral.js"></script>
		<script src="import/shaders/SineParticles.js"></script>
		<script src="import/shaders/Water.js"></script>
		<script src="import/shaders/HexifyRadial.js"></script>
		<script src="import/shaders/SinCosTan.js"></script>
		<script src="import/shaders/HueFx.js"></script>
		<script src="import/shaders/TestFx.js"></script>
		<script src="import/shaders/BasicTest.js"></script>

		<script src="import/nodes/fountain1.js"></script>


		<script>

			if ( !Detector.webgl ) { Detector.addGetWebGLMessage(); } else {

				var glWidth = window.innerWidth;
				var glHeight = window.innerHeight;

				var scene;
				var renderer;
				var camera;
				var controls;
				var container;

				function onLoad(){


					// ----------------


					// ** Standard Three.js setup

					scene = new THREE.Scene();

					renderer = new THREE.WebGLRenderer(); 
					renderer.setSize( glWidth, glHeight );
					renderer.autoClear = false;

					container = document.getElementById( 'container' );
					container.appendChild( renderer.domElement ); 

					camera = new THREE.PerspectiveCamera( 30, glWidth / glHeight, 1, 100000 );
					camera.position.z = 2000;
					controls = new THREE.TrackballControls( camera, renderer.domElement);


					// ----------------


					// ** Initialize PixelMixer

					PX.init(scene, renderer);
					PX.setSize(glWidth, glHeight);
					PX.pointSprite = "images/nodeflare250.png";
					PX.pointSize = 15;
					PX.useTransforms = true;


					// ----------------


					// ** Add Nodes

					//Import CSV array [port, x, y, z] 
					PX.hardware.importNodeArray({nodes: PX.nodeArray, y: -200});

					
					var portCount = PX.ports.getPortCount() - 8;

					PX.hardware.setCustomPointSize(1, 125);
					PX.hardware.setCustomPointSprite(1, "images/nodeblur2.png");

					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;
					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;
					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;
					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;
					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;
					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;
					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;
					portCount++;
					PX.ports.getPort(portCount).nodesType = 1;



					PX.updateNodePoints();


					// ----------------


					// ** Add a Shader to Channel 1

					// Create a list of Clips to add to our Pod
					var clipIds = ["SinSpiral"];
					var clips = [];
					for (var i = 0; i < clipIds.length; i++) {
						clips[i] = new PX.Clip({id: clipIds[i]});
					}

					// Create a Pod to place our clips in 
					var pods = [];
					pods[0] = new PX.Pod({ clips: clips, positionIds: [1, 2, 3, 4, 5, 6] });

					// Add Pod to Channel 1
					var channel1 = new PX.Channel({ mix: 1, pods: pods });
					PX.channels.setChannel(1, channel1);

					// Create pod positions from ports
					PX.channels.podPosFromPorts(2, [1]);
					PX.channels.podPosFromPorts(3, [2]);
					PX.channels.podPosFromPorts(4, [3]);
					PX.channels.podPosFromPorts(5, [4]);
					PX.channels.podPosFromPorts(6, [5, 6, 7, 8, 9, 10, 11, 12]);

					// Create some transforms on the pods
					PX.channels.setPodPosTransforms({id: 1, swapaxis: 1});
					PX.channels.setPodPosTransforms({id: 4, swapaxis: 2, zt: .43});
					PX.channels.setPodPosTransforms({id: 5, swapaxis: 2, zt: .43});
					PX.channels.setPodPosTransforms({id: 6, swapaxis: 3});


					// ----------------


					// ** UI Layer

					var gui = new dat.GUI({
						//load: PX.datguiJson,
						//preset: 'Spiral 1'
					});

					guiData  = {
						Channel1Mix:  1,
						Scale:  1,
						Shader:  "SinSpiral",
						PointSize: 140,
						Mapping:  "setup1"
					};

					// Add preset controls
					gui.remember(guiData);

					gui.add( guiData, "Channel1Mix", 0.0, 1.0, 1.0 )  .onChange(function (v) { PX.set("mix", v, 1);  });

					gui.add( { SnapToFront:function(){

						controls.reset();

					} } ,'SnapToFront');

					var mapping = ["Layout 1", "Layout 2", "Layout 3", "Layout 4", "Layout 5", "Layout 6"];
					gui.add( guiData, 'Mapping', mapping).onChange(function (v) {

						// Clean transforms
						for (var i = 0; i < 15; i++) {
							PX.channels.resetPodPosTransforms(i+1);
						};

						// Reapply transforms
						switchLayout(v);
						
						PX.updateShader();

					});

					gui.add( guiData, 'Shader', PX.demoClipNames).onChange(function (v) { uniformClipTypeChange(v, 1, 1, 1 ); });
					gui.add( guiData, "Scale", 0.1, 1.0, 1.0 )  .onChange(function (v) { PX.set("p1", v, 1, 1, 1);  });
					

					// ----------------


					// ** Start the main loop

					animate();


				}

				function animate() {

					// Main update loop
					if(PX.ready){

						// Update the API
						PX.update();

						// Update Three.js
						controls.update();
						renderer.render( scene, camera );
					}

					// Keep repeating the animation loop
					requestAnimationFrame( animate );
				}


				function onWindowResize() {

					// Resize logic
					glWidth = window.innerWidth;
					glHeight = window.innerHeight;

					PX.setSize(glWidth, glHeight);

					camera.aspect = glWidth / glHeight;
					camera.updateProjectionMatrix();
					controls.handleResize();

				}
				window.addEventListener( 'resize', onWindowResize, false );

			}

		</script>

	</head>

	<body ontouchstart="" onload="onLoad()">

		<div id="container"></div>

	</body>

</html>